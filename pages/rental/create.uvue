<template>
	<scroll-view class="page" scroll-y="true">
		<view class="form-card">
			<view class="card-header-line"><view class="blue-bar"></view><text class="header-text">åŸºæœ¬ä¿¡æ¯</text></view>
			<view class="grid-container">
				<view class="grid-cell" style="width: 100%;">
					<text class="field-label">é€‰æ‹©å®¢æˆ· <text class="req">*</text></text>
					<view class="row-center">
						<picker mode="selector" :range="contactNames" @change="onContactChange" class="flex-1">
							<view class="input-box picker-layout">
								<text class="input-val" :class="form['contact_id']?'text-dark':'text-light'">{{ currentContactName }}</text>
								<text class="icon-arrow">â–¼</text>
							</view>
						</picker>
						<view class="add-btn" @click="showAddModal=true">+</view>
					</view>
				</view>
			</view>
			<view class="grid-container mt-3">
				<view class="grid-cell" style="width: 100%;">
					<text class="field-label">é€‰æ‹©è®¾å¤‡ <text class="req">*</text></text>
					<view class="input-box picker-layout" @click="showProductModal = true">
						<text class="input-val" :class="form['product_id']?'text-dark':'text-light'">{{ currentProductName }}</text>
						<text class="icon-search">ğŸ”</text>
					</view>
				</view>
			</view>
		</view>

		<view class="form-card">
			<view class="card-header-line"><view class="orange-bar"></view><text class="header-text">ç§Ÿèµå‘¨æœŸ</text></view>
			<view class="grid-container">
				<view class="grid-cell">
					<text class="field-label">èµ·ç§Ÿæ—¥æœŸ</text>
					<picker mode="date" :value="form['start_date']" @change="onDateChange" class="picker-full">
						<view class="input-box picker-layout">
							<text class="input-val text-dark">{{ form['start_date'] }}</text>
							<text class="icon-arrow">ğŸ“…</text>
						</view>
					</picker>
				</view>
				<view class="grid-cell">
					<text class="field-label">ç§ŸæœŸæ—¶é•¿ (æœˆ) <text class="req">*</text></text>
					<input class="input-box font-bold" type="number" v-model="form['duration']" placeholder="12" @input="calc" />
				</view>
			</view>
		</view>

		<view class="form-card">
			<view class="card-header-line"><view class="purple-bar"></view><text class="header-text">è´¢åŠ¡æ–¹æ¡ˆ (Pro)</text></view>
			<view class="grid-container">
				<view class="grid-cell">
					<text class="field-label">æŠ¼é‡‘ (Â¥)</text>
					<input class="input-box font-bold" type="digit" v-model="form['deposit']" placeholder="0" @input="calc" />
				</view>
				<view class="grid-cell">
					<text class="field-label">ç§Ÿé‡‘å•ä»· (Â¥)</text>
					<input class="input-box font-bold text-purple" type="digit" v-model="form['rent_price']" placeholder="0" @input="calc" />
				</view>
			</view>
			<view class="grid-container mt-3">
				<view class="grid-cell">
					<text class="field-label">æœˆæŠ˜æ—§ä¼°ç®— (Â¥)</text>
					<input class="input-box text-red" type="digit" v-model="form['depreciation_monthly']" placeholder="æˆæœ¬ä¼°ç®—" @input="calc" />
				</view>
				<view class="grid-cell">
					<text class="field-label">é¦–æœŸæ”¯ä»˜ (Â¥)</text>
					<input class="input-box font-bold text-green" type="digit" v-model="form['first_payment']" placeholder="å«æŠ¼é‡‘" />
				</view>
			</view>
			<view class="profit-box mt-3">
				<text class="profit-label">ğŸ“Š é¢„è®¡æœ¬å•æ¯›åˆ©:</text>
				<text class="profit-val" :class="expectedProfit>=0?'text-green':'text-red'">Â¥{{ expectedProfit }}</text>
			</view>
		</view>
		<view class="placeholder-bottom"></view>
	</scroll-view>

	<view class="fixed-footer">
		<button class="btn-submit" :loading="loading" @click="submit">ç¡®è®¤å‡ºç§Ÿ (è‡ªåŠ¨æŒ‚è´¦)</button>
	</view>
	
	<view v-if="showProductModal" class="modal-mask" style="z-index: 900;"><view class="drawer-box"><view class="drawer-header"><text class="drawer-title">é€‰æ‹©åº“å­˜è®¾å¤‡</text><text class="drawer-close" @click="showProductModal = false">Ã—</text></view><view class="drawer-search"><input class="search-input" v-model="productKeyword" placeholder="è¾“å…¥ç¼–ç æˆ–å‹å·æœç´¢..." /></view><scroll-view scroll-y="true" class="drawer-list"><view v-for="(p, index) in filteredProducts" :key="index" class="product-row" @click="selectProduct(p)"><image :src="p['image'] || '/static/logo.png'" mode="aspectFill" class="p-thumb"></image><view class="p-info"><view class="p-top"><text class="p-code">{{ p['zencode'] }}</text><text class="p-name">{{ p['name'] }}</text></view><text class="p-spec">{{ p['cpu'] }} {{ p['gpu'] }}</text><text class="p-price">æˆæœ¬: Â¥{{ p['cost_price'] }}</text></view><view class="p-check">é€‰</view></view></scroll-view></view></view>
	<view v-if="showAddModal" class="modal-mask" style="z-index: 950;"><view class="modal-center"><view class="modal-title">æ–°å¢å®¢æˆ·</view><input class="modal-input" v-model="newC.name" placeholder="å®¢æˆ·å§“å (å¿…å¡«)" /><input class="modal-input" v-model="newC.phone" placeholder="è”ç³»ç”µè¯" type="number" /><input class="modal-input" v-model="newC.address" placeholder="åœ°å€/å¤‡æ³¨" /><view class="modal-btns"><view class="modal-btn cancel" @click="showAddModal=false">å–æ¶ˆ</view><view class="modal-btn confirm" @click="addContact">ä¿å­˜</view></view></view></view>
</template>

<script>
	import { request } from '@/common/api.js';
	export default {
		data() {
			return {
				loading: false, contacts: [], products: [], contactNames: ['åŠ è½½ä¸­...'], currentContactName: 'è¯·é€‰æ‹©', currentProductName: 'è¯·é€‰æ‹©',
				form: { contact_id: '', product_id: '', deposit: '', rent_price: '', depreciation_monthly: '', start_date: '', duration: '', first_payment: '' } as any,
				expectedProfit: 0, showAddModal: false, newC: { name: '', phone: '', address: '' }, showProductModal: false, productKeyword: ''
			}
		},
		computed: {
			filteredProducts(): any[] {
				if(!this.productKeyword) return this.products;
				let k = this.productKeyword.toLowerCase();
				return this.products.filter((p: any): boolean => (p['zencode'] || '').toString().toLowerCase().includes(k) || (p['name'] || '').toString().toLowerCase().includes(k));
			}
		},
		onLoad() { 
			let now = new Date(); let y = now.getFullYear(); let m = now.getMonth() + 1; let d = now.getDate();
			this.form['start_date'] = `${y}-${m < 10 ? '0'+m : m}-${d < 10 ? '0'+d : d}`;
			this.loadData();
		},
		methods: {
			async loadData() {
				try {
					const cRes = await request({ url: '/api/contacts/?page_size=1000' });
					const pRes = await request({ url: '/api/products/?status=IN_STOCK&page_size=1000' });
					if(cRes) { let list = (cRes as any)['results'] || cRes; this.contacts = list as any[]; this.contactNames = this.contacts.map((c: any): string => c['name']); }
					if(pRes) { let list = (pRes as any)['results'] || pRes; this.products = list as any[]; }
				} catch(e) {}
			},
			calc() {
				let dur = parseFloat(this.form['duration'] || 0);
				let rent = parseFloat(this.form['rent_price'] || 0);
				let dep = parseFloat(this.form['deposit'] || 0);
				let depr = parseFloat(this.form['depreciation_monthly'] || 0);
				if(!this.form['first_payment'] && rent > 0) this.form['first_payment'] = (dep + rent).toString();
				this.expectedProfit = (rent * dur) - (depr * dur);
			},
			async addContact() {
				if(!this.newC.name) return uni.showToast({title:'å§“åå¿…å¡«', icon:'none'});
				try {
					const res = await request({ url: '/api/contacts/', method: 'POST', data: this.newC });
					await this.loadData();
					this.form['contact_id'] = (res as any).id; this.currentContactName = (res as any).name; this.showAddModal = false; this.newC = { name: '', phone: '', address: '' }; 
				} catch(e) { uni.showToast({title:'å¤±è´¥', icon:'none'}); }
			},
			onContactChange(e: any) { let idx = e.detail.value as number; if(this.contacts[idx]) { this.form['contact_id'] = this.contacts[idx]['id']; this.currentContactName = this.contacts[idx]['name']; } },
			onDateChange(e: any) { this.form['start_date'] = e.detail.value; },
			selectProduct(p: any) { this.form['product_id'] = p['id']; this.currentProductName = `${p['zencode']} - ${p['name']}`; this.showProductModal = false; },
			async submit() {
				if(!this.form['contact_id']) return uni.showToast({title:'è¯·é€‰æ‹©å®¢æˆ·', icon:'none'});
				if(!this.form['product_id']) return uni.showToast({title:'è¯·é€‰æ‹©è®¾å¤‡', icon:'none'});
				this.loading = true;
				try { 
					let submitData = JSON.parse(JSON.stringify(this.form));
					if(!submitData.first_payment) { let dep = parseFloat(submitData.deposit || 0); let rent = parseFloat(submitData.rent_price || 0); submitData.first_payment = dep + rent; }
					await request({ url: '/api/rentals/create_lease/', method: 'POST', data: submitData }); 
					uni.showToast({ title: 'å¼€å•æˆåŠŸ' });
					setTimeout(() => { uni.navigateBack(); }, 800); 
				} catch(e: any) { uni.showModal({ title: 'å¼€å•å¤±è´¥', content: (e.data && e.data.error) || 'è¯·æ±‚å¤±è´¥', showCancel: false }); } finally { this.loading = false; }
			}
		}
	}
</script>
<style>
	.page { padding: 30rpx; background-color: #f8fafc; height: 100vh; box-sizing: border-box; }
	.form-card { background-color: #fff; border-radius: 20rpx; padding: 30rpx; margin-bottom: 30rpx; box-shadow: 0 4rpx 10rpx rgba(0,0,0,0.02); }
	.card-header-line { display: flex; flex-direction: row; align-items: center; margin-bottom: 30rpx; }
	.blue-bar { width: 8rpx; height: 32rpx; background-color: #2563eb; border-radius: 4rpx; margin-right: 16rpx; }
	.purple-bar { width: 8rpx; height: 32rpx; background-color: #9333ea; border-radius: 4rpx; margin-right: 16rpx; }
	.orange-bar { width: 8rpx; height: 32rpx; background-color: #f59e0b; border-radius: 4rpx; margin-right: 16rpx; }
	.header-text { font-size: 32rpx; font-weight: bold; color: #1e293b; }
	.grid-container { display: flex; flex-direction: row; justify-content: space-between; width: 100%; flex-wrap: wrap; }
	.grid-cell { width: 48%; display: flex; flex-direction: column; }
	.mt-3 { margin-top: 30rpx; }
	.field-label { font-size: 26rpx; font-weight: bold; color: #64748b; margin-bottom: 12rpx; display: block; }
	.req { color: #ef4444; margin-left: 4rpx; }
	.input-box { width: 100%; height: 100rpx; background-color: #fff; border: 1px solid #cbd5e1; border-radius: 16rpx; padding: 0 20rpx; font-size: 30rpx; color: #333; box-sizing: border-box; display: flex; align-items: center; }
	.picker-full { width: 100%; }
	.picker-layout { display: flex; flex-direction: row; justify-content: space-between; align-items: center; }
	.input-val { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
	.text-dark { color: #333; } .text-light { color: #94a3b8; } .icon-arrow { font-size: 24rpx; color: #cbd5e1; margin-left: 10rpx; font-weight: bold; } .icon-search { font-size: 30rpx; }
	.row-center { display: flex; flex-direction: row; align-items: center; gap: 20rpx; }
	.flex-1 { flex: 1; }
	.add-btn { width: 80rpx; height: 100rpx; background-color: #eff6ff; border: 1px solid #bfdbfe; border-radius: 16rpx; display: flex; align-items: center; justify-content: center; color: #2563eb; font-size: 40rpx; font-weight: bold; }
	.font-bold { font-weight: bold; } .text-purple { color: #9333ea; } .text-red { color: #ef4444; } .text-green { color: #16a34a; }
	.profit-box { background-color: #f1f5f9; padding: 20rpx; border-radius: 12rpx; display: flex; flex-direction: row; justify-content: space-between; align-items: center; }
	.profit-label { font-size: 28rpx; font-weight: bold; color: #64748b; }
	.profit-val { font-size: 32rpx; font-weight: 900; }
	.placeholder-bottom { height: 180rpx; }
	.fixed-footer { position: fixed; bottom: 0; left: 0; right: 0; background-color: #fff; padding: 20rpx 30rpx 60rpx 30rpx; box-shadow: 0 -4rpx 20rpx rgba(0,0,0,0.05); z-index: 100; }
	.btn-submit { background-color: #9333ea; color: #fff; height: 100rpx; line-height: 100rpx; border-radius: 20rpx; font-size: 34rpx; font-weight: bold; border: none; width: 100%; }
	/* Modal Styles */
	.modal-mask { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); z-index: 999; display: flex; align-items: flex-end; justify-content: center; }
	.drawer-box { background-color: #fff; border-top-left-radius: 30rpx; border-top-right-radius: 30rpx; height: 75vh; width: 100%; display: flex; flex-direction: column; }
	.drawer-header { padding: 30rpx; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
	.drawer-title { font-size: 32rpx; font-weight: bold; color: #333; }
	.drawer-close { font-size: 40rpx; color: #999; padding: 0 20rpx; }
	.drawer-search { padding: 20rpx 30rpx; background-color: #fff; border-bottom: 1px solid #f1f5f9; }
	.search-input { background-color: #f1f5f9; height: 80rpx; border-radius: 16rpx; padding: 0 20rpx; font-size: 28rpx; }
	.drawer-list { flex: 1; padding: 0 30rpx; box-sizing: border-box; }
	.product-row { padding: 24rpx 0; border-bottom: 1px solid #f1f5f9; display: flex; flex-direction: row; align-items: center; }
	.p-thumb { width: 100rpx; height: 100rpx; border-radius: 12rpx; background-color: #eee; margin-right: 20rpx; }
	.p-info { flex: 1; margin-right: 20rpx; overflow: hidden; }
	.p-top { display: flex; flex-direction: row; align-items: center; margin-bottom: 6rpx; }
	.p-code { font-size: 22rpx; background-color: #e0e7ff; color: #3730a3; padding: 2rpx 8rpx; border-radius: 6rpx; margin-right: 12rpx; font-weight: bold; min-width: 60rpx; text-align: center; }
	.p-name { font-size: 28rpx; font-weight: bold; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
	.p-spec { font-size: 22rpx; color: #64748b; margin-bottom: 4rpx; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
	.p-price { font-size: 22rpx; color: #f59e0b; }
	.p-check { background-color: #f3e8ff; color: #9333ea; font-size: 24rpx; padding: 8rpx 20rpx; border-radius: 30rpx; font-weight: bold; }
	.modal-center { background-color: #fff; width: 600rpx; border-radius: 24rpx; padding: 40rpx; margin-bottom: 50vh; }
	.modal-title { text-align: center; font-size: 34rpx; font-weight: bold; margin-bottom: 40rpx; }
	.modal-input { background-color: #f8fafc; height: 90rpx; border-radius: 12rpx; padding: 0 24rpx; margin-bottom: 24rpx; font-size: 30rpx; border: 1px solid #e2e8f0; }
	.modal-btns { display: flex; flex-direction: row; justify-content: space-between; margin-top: 20rpx; }
	.modal-btn { width: 48%; height: 80rpx; line-height: 80rpx; text-align: center; border-radius: 12rpx; font-size: 30rpx; font-weight: bold; }
	.cancel { background-color: #f1f5f9; color: #64748b; }
	.confirm { background-color: #2563eb; color: #fff; }
</style>